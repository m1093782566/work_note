1, You are not authorized to perform the requested action: admin_required (Disable debug mode to suppress these details.) (HTTP 403)
表示你还没有通过keystone的用户认证。解决：source一下keystone的环境变量。

2, 调用ceilometer API时如果出现连接不上的情况（8777端口访问被拒绝），说明ceilometer API daemon没有启动。解决：通过ps aux | grep ceilometer确认ceilometer daemons是不是真的没有启动，若猜想属实，则通过rejoin-screen或service重启ceilometer-api。

3, 重新启动虚拟机后，发现调用ceilometer的meter-list得到compute.node.cpu的metrics，前提是在/etc/nova.config中添加下面这一行：
compute_monitors = ComputeDriverCPUMonitor

4, Nova does not generate the periodic notifications for all known instances by default. To enable these auditing events, set instance_usage_audit to true in the nova configuration file.

5，change `notification_driver = messaging` to `notification_driver=cinder.openstack.common.notifier.rpc_notifier` 

Cinder does not generate notifications by default. To enable these auditing events, set the above in the cinder configuration file.

6，change database backend as mongodb

https://github.com/openstack/ceilometer/blob/master/doc/source/install/manual.rst#mongodb

7，有些metric需要你做操作才会有显示出来（特别是来自notification的一些信息，比如image.download）。

8，重装devstack的时候，首先要将OS_SERVICE等环境变量清空。然后在执行stack.sh脚本的时候可能会出现与glanceclient(RROR: glanceclient.common.http Request returned failure status 404.)或者n-x**相关的错误，而且不同执行时间肯能会出现不一样的错误。解决：重启虚拟机？执行unstack.sh脚本？执行clean.sh脚本？总之，这些问题都不是大问题。

9，刚刚装好的devstack，meter-list命令看不到任何的metrics。需要你一点点地操作然后一点点地配置才会有数据。

10，devstack/stackrc定义了安装devstack过程中需要的一些变量，包括git_repo，enable_service等。

11，如果出现下述错误：
014-10-31 02:36:01.956 | ++ keystone token-get
2014-10-31 02:36:01.956 | ++ grep ' id '
2014-10-31 02:36:01.957 | ++ get_field 2
2014-10-31 02:36:01.957 | ++ local data field
2014-10-31 02:36:01.957 | ++ read data
2014-10-31 02:36:02.617 | Configuration error: Client configured to run without a service catalog. Run the client using --os-auth-url or OS_AUTH_URL, instead of --os-endpoint or OS_SERVICE_ENDPOINT, for example.
2014-10-31 02:36:02.644 | + TOKEN=
2014-10-31 02:36:02.645 | + die_if_not_set 1153 TOKEN 'Keystone fail to get token'
2014-10-31 02:36:02.645 | + local exitcode=0
2014-10-31 02:36:02.650 | [Call Trace]
2014-10-31 02:36:02.650 | ./stack.sh:1153:die_if_not_set
2014-10-31 02:36:02.650 | /home/vcap/devstack/functions-common:25

这是因为keystone的环境变量（OS_SERVICE_*）残留导致，使用下面的链接提供的方案清除这些环境变量。
https://bugs.launchpad.net/devstack/+bug/1252576
但使用上述方案后可能出现其它错误：

2014-10-31 03:01:14.212 | Authorization Failed: An unexpected error prevented the server from fulfilling your request: No module named backends.sql (Disable debug mode to suppress these details.) (HTTP 500)
2014-10-31 03:01:14.242 | + TOKEN=

具体原因可能包括：旧的包（deb，pip）依赖，旧的配置文件（/etc/nova等）。我使用的方法是：执行devstack下的clean.sh脚本，并且配合apt-get autoremove删除旧的包链接。其实使用apt-get install安装的软件都会在/var/cache下缓存deb包。然后再重启虚拟机，最后执行stack.sh脚本。

注：devstack安装过程中的主要步骤包括：
0，读入各种环境变量，其中一部分来自local.conf
1，apt-get install
2，pip
以上的包的部分启动脚本放在/usr/local/bin里面。

3，git clone git@openstack.org（大部分与github上面的不同）。

4，配置/etc/...

5，启动服务（nova-api等）

6，调用各种api（比如glance-api上传镜像）

7，建立／读／写数据库。

11，devstack的日志放在：/opt/stack/logs/screen下，比如nova-api，ceilometer-api等。然后一部分放在/var/log下，比如ceilometer-api等，但这些参考意义不大，因为很过期。

12，自己源码安装libvirt-1.1.2后，launch instance时出现下面错误：
错误： 创建实例 "nova-1" 失败: 请稍后再试 [错误: Build of instance c054dd3f-3fe3-4f30-b24f-578c46f1b1c0 aborted: Flavor's disk is too small for requested image.].
solutions: flavor:tiny, image:cirrors
另外，2014-11-04 08:57:41.416 DEBUG oslo.db.api [req-bd49412c-4e51-43c5-b337-120635cffadd None None] Loading backend 'sqlalchemy' from 'nova.db.sqlalchemy.api' from (pid=11859) _load_backend /usr/local/lib/python2.7/dist-packages/oslo/db/api.py:182
2014-11-04 08:57:41.963 DEBUG oslo.db.sqlalchemy.session [req-bd49412c-4e51-43c5-b337-120635cffadd None None] MySQL server mode set to STRICT_TRANS_TABLES,STRICT_ALL_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,TRADITIONAL,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION from (pid=11859) _check_effective_sql_mode /usr/local/lib/python2.7/dist-packages/oslo/db/sqlalchemy/session.py:508
这些debug信息不是什么大问题。

13，有时候reboot devstack虚拟机后会出现类似下面的错误：

HTTPConnectionPool(host='192.168.1.12', port=8774): Max retries exceeded with url: /v2/70a04e8259b04717bf1bdd4faaedbc0c/extensions (Caused by <class 'sockerror'>: [Errno 111] Connection refused)

这可能是nova-api服务没有正常启动的原因，只需重新启动一下nova-api服务应该就能解决。

14，drop database ceilometer后，使用ceilometer meter-list出现500错误。而且在重启ceilometer各服务后database也没有恢复，依旧出现500错误。重装devstack后，问题修复。一个纯净的devstack（没有创建任何虚拟机时）是没有任何meter的。

15，ceilometer的默认监控项实在是让人头痛。现在能够一定程度上确定的是：pipeline.yaml与实际得到的监控数据没有太大关系。例证：image在pipeline.yaml里面没有，但meter-list却有。
创建虚拟机后并绑定floating ip，配置sg，mount云硬盘后，出现的监控项有27个：
mysql> select * from meter;
+----+----------------------------+------------+----------+
| id | name                       | type       | unit     |
+----+----------------------------+------------+----------+
| 22 | cpu                        | cumulative | ns       |
| 18 | disk.device.read.bytes     | cumulative | B        |
| 25 | disk.device.read.requests  | cumulative | request  |
| 24 | disk.device.write.bytes    | cumulative | B        |
| 15 | disk.device.write.requests | cumulative | request  |
|  9 | disk.ephemeral.size        | gauge      | GB       |
| 19 | disk.read.bytes            | cumulative | B        |
| 17 | disk.read.requests         | cumulative | request  |
| 10 | disk.root.size             | gauge      | GB       |
| 13 | disk.write.bytes           | cumulative | B        |
| 16 | disk.write.requests        | cumulative | request  |
|  1 | image                      | gauge      | image    |
| 11 | image.download             | delta      | B        |
| 12 | image.serve                | delta      | B        |
|  4 | image.size                 | gauge      | B        |
|  2 | image.update               | delta      | image    |
|  3 | image.upload               | delta      | image    |
|  7 | instance                   | gauge      | instance |
|  6 | instance:m1.tiny           | gauge      | instance |
|  8 | memory                     | gauge      | MB       |
| 20 | network.incoming.bytes     | cumulative | B        |
| 21 | network.incoming.packets   | cumulative | packet   |
| 14 | network.outgoing.bytes     | cumulative | B        |
| 23 | network.outgoing.packets   | cumulative | packet   |
|  5 | vcpus                      | gauge      | vcpu     |
| 27 | volume                     | gauge      | volume   |
| 26 | volume.size                | gauge      | GB       |
+----+----------------------------+------------+----------+

经过一段时间后，总meter数量到达了36个（新增cpu_util等，不包括compute.node）。

这期间一直在做的事情就是fix cpu.py的python语法错误（LOG.debug("message")）,fix之后过了一段时间（1h），在agent-notification和collector的log中看到了compute.node.cpu.*的相关数据采集到（sample）和record_data(db)
agent-notification.log里的相关信息如下：

2014-11-13 12:48:12.984 15105 DEBUG ceilometer.compute.notifications.cpu [-] dujun_log:Find compute.node info {'event_type': u'compute.metrics.update', 'timestamp': '2014-11-13 04:48:12.934255', 'publisher_id': u'compute.ubuntu', 'payload': {u'timestamp': u'2014-11-13T04:48:12.934255', u'name': u'cpu.percent', u'value': 0.021414866621278703, u'source': u'libvirt.LibvirtDriver'}, 'resource_id': u'ubuntu_ubuntu'} process_notification /opt/stack/ceilometer/ceilometer/compute/notifications/cpu.py:57
2014-11-13 12:48:12.995 15105 DEBUG ceilometer.pipeline [-] Pipeline meter_sink: Transform sample <name: compute.node.cpu.percent, volume: 2.14148666213, resource_id: ubuntu_ubuntu, timestamp: 2014-11-13 04:48:12.934255> from 0 transformer _publish_samples /opt/stack/ceilometer/ceilometer/pipeline.py:296

collector.log的信息如下：

2014-11-13 12:49:13.983 14499 DEBUG ceilometer.dispatcher.database [-] metering data compute.node.cpu.kernel.percent for ubuntu_ubuntu @ 2014-11-13 04:49:13.942597: 0.373011293381 record_metering_data /opt/stack/ceilometer/ceilometer/dispatcher/database.py:81
2014-11-13 12:49:14.003 14500 DEBUG ceilometer.dispatcher.database [-] metering data compute.node.cpu.percent for ubuntu_ubuntu @ 2014-11-13 04:49:13.942597: 3.22314730855 record_metering_data /opt/stack/ceilometer/ceilometer/dispatcher/database.py:81
2014-11-13 12:49:14.122 14501 DEBUG ceilometer.dispatcher.database [-] metering data compute.node.cpu.iowait.time for ubuntu_ubuntu @ 2014-11-13 04:49:13.942597: 234210000000 record_metering_data /opt/stack/ceilometer/ceilometer/dispatcher/database.py:81
2014-11-13 12:49:14.142 14502 DEBUG ceilometer.dispatcher.database [-] metering data compute.node.cpu.user.percent for ubuntu_ubuntu @ 2014-11-13 04:49:13.942597: 2.81922347704 record_metering_data /opt/stack/ceilometer/ceilometer/dispatcher/database.py:81
2014-11-13 12:49:14.164 14499 DEBUG ceilometer.dispatcher.database [-] metering data compute.node.cpu.kernel.time for ubuntu_ubuntu @ 2014-11-13 04:49:13.942597: 3079000000000 record_metering_data /opt/stack/ceilometer/ceilometer/dispatcher/database.py:81
2014-11-13 12:49:14.183 14500 DEBUG ceilometer.dispatcher.database [-] metering data compute.node.cpu.iowait.percent for ubuntu_ubuntu @ 2014-11-13 04:49:13.942597: 0.0309125381255 record_metering_data /opt/stack/ceilometer/ceilometer/dispatcher/database.py:81
2014-11-13 12:49:14.030 14556 DEBUG ceilometer.dispatcher.database [-] metering data compute.node.cpu.idle.time for ubuntu_ubuntu @ 2014-11-13 04:49:13.942597: 1239380770000000 record_metering_data /opt/stack/ceilometer/ceilometer/dispatcher/database.py:81
2014-11-13 12:49:14.057 14557 DEBUG ceilometer.dispatcher.database [-] metering data compute.node.cpu.frequency for ubuntu_ubuntu @ 2014-11-13 04:49:13.942597: 2000 record_metering_data /opt/stack/ceilometer/ceilometer/dispatcher/database.py:81
2014-11-13 12:49:14.077 14558 DEBUG ceilometer.dispatcher.database [-] metering data compute.node.cpu.user.time for ubuntu_ubuntu @ 2014-11-13 04:49:13.942597: 23888780000000 record_metering_data /opt/stack/ceilometer/ceilometer/dispatcher/database.py:81

这时候的问题是：ceilometer数据库中的meter和sample表中已经有了compute.node.cpu.*的数据，但是$ ceilometer meter-list还是没有相关数据显示。通过screen可以看到，ceilometer-api服务并没有启动，原因是端口被占用。但是通过API call的方式就可以获取compute.node.cpu.*的数据。
$ source meters.sh
{
        "meter_id": "dWJ1bnR1X3VidW50dStjb21wdXRlLm5vZGUuY3B1LnVzZXIucGVyY2VudA==\n", 
        "name": "compute.node.cpu.user.percent", 
        "project_id": null, 
        "resource_id": "ubuntu_ubuntu", 
        "source": "openstack", 
        "type": "gauge", 
        "unit": "%", 
        "user_id": null
    }, 
    {
        "meter_id": "dWJ1bnR1X3VidW50dStjb21wdXRlLm5vZGUuY3B1Lmtlcm5lbC50aW1l\n", 
        "name": "compute.node.cpu.kernel.time", 
        "project_id": null, 
        "resource_id": "ubuntu_ubuntu", 
        "source": "openstack", 
        "type": "cumulative", 
        "unit": "ns", 
        "user_id": null
    }, 
    {
        "meter_id": "dWJ1bnR1X3VidW50dStjb21wdXRlLm5vZGUuY3B1Lmlvd2FpdC5wZXJjZW50\n", 
        "name": "compute.node.cpu.iowait.percent", 
        "project_id": null, 
        "resource_id": "ubuntu_ubuntu", 
        "source": "openstack", 
        "type": "gauge", 
        "unit": "%", 
        "user_id": null
    }

ceilometer-api service 启动命令(先kill占用端口的ceilometer-api进程)：
/usr/bin/python /usr/local/bin/ceilometer-api -d -v --log-dir=/var/log/ceilometer-api --config-file /etc/ceilometer/ceilometer.conf

成功重启ceilometer-api服务后，meter-list还是获取不到compute.node.cpu.*的数据。

16，官方文档宣称memroy.usage在libvirt中是支持的，但是通过查看agent-compute.log发现：
2014-11-12 14:17:04.417 27476 INFO ceilometer.agent [-] Polling pollster memory.usage in the context of meter_source
2014-11-12 14:17:04.418 27476 DEBUG ceilometer.compute.pollsters.memory [-] Checking memory usage for instance 990889ce-5016-40be-ba53-cd1610198622 get_samples /opt/stack/ceilometer/ceilometer/compute/pollsters/memory.py:31
2014-11-12 14:17:04.425 27476 WARNING ceilometer.compute.virt.libvirt.inspector [-] Failed to inspect memory usage of instance-00000001, can not get info from libvirt
2014-11-12 14:17:04.426 27476 ERROR ceilometer.compute.pollsters.memory [-] Could not get Memory Usage for 990889ce-5016-40be-ba53-cd1610198622: 'NoneType' object has no attribute 'usage'
2014-11-12 14:17:04.426 27476 TRACE ceilometer.compute.pollsters.memory Traceback (most recent call last):
2014-11-12 14:17:04.426 27476 TRACE ceilometer.compute.pollsters.memory   File "/opt/stack/ceilometer/ceilometer/compute/pollsters/memory.py", line 37, in get_samples
2014-11-12 14:17:04.426 27476 TRACE ceilometer.compute.pollsters.memory     'usage': memory_info.usage}))
2014-11-12 14:17:04.426 27476 TRACE ceilometer.compute.pollsters.memory AttributeError: 'NoneType' object has no attribute 'usage'
